#!/bin/bash
# Git pre-commit hook per validare sintassi PHP
# Installazione: cp scripts/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Colori per output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Trova la root del repository
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Valida solo i file PHP staged (escludendo vendor, node_modules)
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.php$' | grep -v '^vendor/' | grep -v '^node_modules/')

if [ -z "$STAGED_PHP_FILES" ]; then
    exit 0
fi

echo -e "${YELLOW}üîç Validazione sintassi PHP (pre-commit hook)...${NC}"
echo ""

ERRORS=0
FILES_CHECKED=0

for file in $STAGED_PHP_FILES; do
    if [ -f "$REPO_ROOT/$file" ]; then
        FILES_CHECKED=$((FILES_CHECKED + 1))
        if php -l "$REPO_ROOT/$file" > /dev/null 2>&1; then
            echo -e "${GREEN}‚úì${NC} $file"
        else
            echo -e "${RED}‚úó${NC} $file"
            php -l "$REPO_ROOT/$file" 2>&1 | head -5
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Commit bloccato: trovati $ERRORS errori di sintassi PHP${NC}"
    echo -e "${RED}Correggi gli errori prima di committare.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Tutti i file PHP hanno sintassi valida ($FILES_CHECKED file controllati)${NC}"
exit 0

