name: CI

on:
  push:
    branches: [ "master" ]
    paths:
      - '**.php'
      - 'composer.json'
      - 'composer.lock'
      - '.github/workflows/ci.yml'
      - 'phpstan.neon'
      - 'psalm.xml'
      - '.php-cs-fixer.dist.php'
      - 'phpunit.xml*'
  pull_request:
    branches: [ "master" ]
    paths:
      - '**.php'
      - 'composer.json'
      - 'composer.lock'
      - '.github/workflows/ci.yml'
      - 'phpstan.neon'
      - 'psalm.xml'
      - '.php-cs-fixer.dist.php'
      - 'phpunit.xml*'

permissions:
  contents: read

jobs:
  # Job per determinare quali file sono stati modificati
  changes:
    runs-on: ubuntu-latest
    outputs:
      php: ${{ steps.filter.outputs.php }}
      composer: ${{ steps.filter.outputs.composer }}
      config: ${{ steps.filter.outputs.config }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            php:
              - '**.php'
            composer:
              - 'composer.json'
              - 'composer.lock'
            config:
              - 'phpstan.neon'
              - 'psalm.xml'
              - '.php-cs-fixer.dist.php'

  # Validazione sintassi PHP (sempre eseguita se ci sono file PHP)
  # Questo job √® veloce e viene eseguito in parallelo con altri job
  syntax:
    needs: changes
    if: needs.changes.outputs.php == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl, zip
          coverage: none
      
      - name: Validate PHP syntax
        run: |
          echo "üîç Validating PHP syntax..."
          ERRORS=0
          FILES_CHECKED=0
          while IFS= read -r -d '' file; do
            FILES_CHECKED=$((FILES_CHECKED + 1))
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Syntax error in: $file"
              php -l "$file" 2>&1 | head -3
              ERRORS=$((ERRORS + 1))
            fi
          done < <(find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/node_modules/*" ! -path "*/.git/*" -print0)
          
          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå PHP syntax validation failed! Found $ERRORS errors in $FILES_CHECKED files."
            exit 1
          fi
          echo "‚úÖ All PHP files have valid syntax ($FILES_CHECKED files checked)"

  # Validazione Composer
  composer:
    needs: changes
    if: needs.changes.outputs.composer == 'true' || needs.changes.outputs.php == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
          coverage: none
      
      - name: Validate composer.json structure
        run: |
          echo "üîç Validating composer.json structure (ignoring lock file)..."
          # Valida SOLO la struttura di composer.json, ignora completamente composer.lock
          # Questo step NON fallisce mai su problemi di composer.lock
          composer validate --no-check-lock --strict
          echo "‚úÖ composer.json structure is valid"
      
      - name: Check composer.lock sync status (info only)
        run: |
          echo "üîç Checking composer.lock sync status (informational only)..."
          # Verifica se composer.lock √® desincronizzato (NON fallisce il build)
          # Questo √® solo informativo
          set +e
          LOCK_CHECK=$(composer validate --strict 2>&1 || true)
          LOCK_EXIT=$?
          set -e
          
          if [ $LOCK_EXIT -ne 0 ] && echo "$LOCK_CHECK" | grep -q "Lock file is not up to date"; then
            echo "‚ö†Ô∏è  INFO: composer.lock is out of sync with composer.json"
            echo "‚ÑπÔ∏è  This is normal and does not block the build"
            echo "‚ÑπÔ∏è  To fix: Run the 'Update composer.lock' workflow manually"
            echo ""
            echo "üìã Details:"
            echo "$LOCK_CHECK" | grep -A 15 "Lock file errors" || echo "$LOCK_CHECK" | tail -10
          elif [ $LOCK_EXIT -eq 0 ]; then
            echo "‚úÖ composer.lock is synchronized with composer.json"
          else
            echo "‚ÑπÔ∏è  composer.lock validation returned: $LOCK_EXIT"
            echo "$LOCK_CHECK" | tail -5
          fi
        continue-on-error: true
      
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.json', '**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-
      
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          composer install --prefer-dist --no-progress --no-interaction || {
            echo "‚ùå composer install failed. This usually means composer.lock is out of sync with composer.json"
            echo "üîß Solution: Run 'composer update' on your server or locally, then commit composer.lock"
            exit 1
          }
      
      - name: Security Audit
        run: |
          if composer audit --no-interaction; then
            echo "‚úÖ Security audit passed"
          else
            echo "‚ö†Ô∏è Security audit found vulnerabilities - please review"
            echo "This is a warning, not blocking the build"
          fi
        continue-on-error: true

  # PHPStan Static Analysis
  phpstan:
    needs: [changes, composer]
    if: (needs.changes.outputs.php == 'true' || needs.changes.outputs.config == 'true') && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl, zip
          coverage: none
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-
      
      - name: Cache PHPStan
        uses: actions/cache@v4
        with:
          path: .phpstan
          key: ${{ runner.os }}-phpstan-${{ hashFiles('phpstan.neon', '**/*.php') }}
          restore-keys: |
            ${{ runner.os }}-phpstan-
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=1G

  # Psalm Static Analysis
  psalm:
    needs: [changes, composer]
    if: (needs.changes.outputs.php == 'true' || needs.changes.outputs.config == 'true') && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl, zip
          coverage: none
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-
      
      - name: Cache Psalm
        uses: actions/cache@v4
        with:
          path: .psalm
          key: ${{ runner.os }}-psalm-${{ hashFiles('psalm.xml', '**/*.php') }}
          restore-keys: |
            ${{ runner.os }}-psalm-
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Run Psalm
        run: vendor/bin/psalm

  # PHP CS Fixer Code Style
  cs-fixer:
    needs: [changes, composer]
    if: (needs.changes.outputs.php == 'true' || needs.changes.outputs.config == 'true') && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl, zip
          coverage: none
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-
      
      - name: Cache PHP CS Fixer
        uses: actions/cache@v4
        with:
          path: .php-cs-fixer.cache
          key: ${{ runner.os }}-cs-fixer-${{ hashFiles('.php-cs-fixer.dist.php', '**/*.php') }}
          restore-keys: |
            ${{ runner.os }}-cs-fixer-
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Run PHP CS Fixer (dry-run)
        run: |
          echo "üîç Running PHP CS Fixer (dry-run)..."
          vendor/bin/php-cs-fixer fix --dry-run --diff --verbose --cache-file=.php-cs-fixer.cache
          if [ $? -eq 0 ]; then
            echo "‚úÖ Code style check passed"
          else
            echo "‚ùå Code style issues found. Run 'composer cs-fix' to fix them automatically."
            exit 1
          fi

  # Test Suite
  test:
    needs: [changes, composer]
    if: needs.changes.outputs.php == 'true' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl, zip
          coverage: none
      
      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      
      - name: Run test suite
        run: |
          if [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
            echo "üß™ Running PHPUnit tests..."
            vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=junit.xml
            echo "‚úÖ Tests passed"
          else
            echo "‚ö†Ô∏è Test suite not configured (phpunit.xml not found)"
            echo "Skipping tests - this is not a failure"
          fi
        continue-on-error: false
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

